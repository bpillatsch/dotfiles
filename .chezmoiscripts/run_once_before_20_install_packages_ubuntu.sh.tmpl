{{ if (and (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "debian" "ubuntu")) -}}
#!/usr/bin/env bash

set -eufo pipefail

echo -e "\033[0;32m>>>>>> Begin Setting Up Ubuntu/Debian Packages <<<<<<\033[0m"

echo "fix for debian bookworm"
{{  if ne .chezmoi.username "root" -}}
sudo apt update && apt upgrade -y
sudo apt install -y software-properties-common python3-launchpadlib
{{ else -}}
apt update && apt upgrade -y
apt install -y software-properties-common python3-launchpadlib
{{ end -}}

repositories=(
  ppa:neovim-ppa/stable
)

packages=(
  curl
  git
  thefuck
  bat
  nala
  neofetch
  neovim
  ripgrep
  btop
  fd-find
  duf
)

for repo in ${repositories[@]}; do
  ppa_repo_source=${repo#ppa:}
  if ! $(apt-cache policy | grep http | awk '{print $2}' | sort -u) | grep $ppa_repo_source &> /dev/null; then
    echo "adding $repo repository to apt"
{{  if ne .chezmoi.username "root" -}}
    sudo add-apt-repository -y $repo
{{  else -}}
    add-apt-repository -y $repo
{{  end -}}
    echo "false??" #why?
  fi
done

for package in ${packages[@]}; do
  if ! $(dpkg-query -W -f='installed' $package &> /dev/null); then
    echo "installing $package"
{{  if ne .chezmoi.username "root" -}}
    sudo apt install -y $package
{{  else -}}
    apt install -y $package
{{  end -}}
  fi
done

if ! command -v atuin &> /dev/null; then
  echo "installing atuin"
  bash <(curl --proto '=https' --tlsv1.2 -sSf https://setup.atuin.sh)
fi

if ! command -v eza &> /dev/null; then
  echo "installing eza"
  sudo mkdir -p /etc/apt/keyrings
  wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
  echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | sudo tee /etc/apt/sources.list.d/gierens.list
  sudo chmod 644 /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/gierens.list
  sudo apt update
  sudo apt install -y eza
fi

if ! command -v deb-get &> /dev/null; then
  echo "installing deb-get"
  sudo apt install -y curl lsb-release wget
  curl -sL https://raw.githubusercontent.com/wimpysworld/deb-get/main/deb-get | sudo -E bash -s install deb-get
fi

if ! command -v dust &> /dev/null; then
  echo "installing dust"
  sudo deb-get install -y du-dust
fi

if ! command -v tldr &> /dev/null; then
  echo "installing tldr"
  curl -sL -o $HOME/.local/bin/tldr https://github.com/dbrgn/tealdeer/releases/download/v1.6.1/tealdeer-linux-x86_64-musl
  chmod +x $HOME/.local/bin/tldr
  $HOME/.local/bin/tldr -u
fi

echo -e "\033[0;32m>>>>>> Finish Setting Up Ubuntu/Debian Packages <<<<<<\033[0m"
{{ end -}}
